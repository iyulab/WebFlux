name: âš¡ Performance and LongRunning Tests

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ì¼ ìƒˆë²½ 3ì‹œ UTC = ì˜¤í›„ 12ì‹œ KST)
  schedule:
    - cron: '0 3 * * *'
  # main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ (ì„ íƒì )
  push:
    branches: [ main ]
    paths:
      - 'src/WebFlux/**/*.cs'
      - 'tests/WebFlux.Tests/Performance/**/*.cs'

env:
  DOTNET_VERSION: '10.0.x'
  BUILD_CONFIGURATION: 'Release'

jobs:
  performance-tests:
    name: ðŸ”¬ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Restore Dependencies
        run: dotnet restore WebFlux.sln

      - name: ðŸ”¨ Build Solution
        run: dotnet build WebFlux.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: âš¡ Run Performance Tests (excluding LongRunning)
        run: dotnet test tests/WebFlux.Tests/WebFlux.Tests.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --filter "Category=Performance&Category!=LongRunning"

      - name: ðŸ“Š Performance Test Summary
        if: always()
        run: |
          echo "âœ… Performance tests completed"
          echo "ðŸ”¬ Tested: Memory efficiency, large document processing, GC pressure"
          echo "â±ï¸ Duration: ~5-10 minutes"

  long-running-tests:
    name: ðŸ• Long Running Tests (Manual Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 120
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Restore Dependencies
        run: dotnet restore WebFlux.sln

      - name: ðŸ”¨ Build Solution
        run: dotnet build WebFlux.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: ðŸ• Run LongRunning Tests
        run: dotnet test tests/WebFlux.Tests/WebFlux.Tests.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --filter "Category=LongRunning"

      - name: ðŸ“Š LongRunning Test Summary
        if: always()
        run: |
          echo "âœ… Long running tests completed"
          echo "ðŸ• Duration: Variable (10 minutes to 24 hours depending on test)"
          echo "ðŸ”¬ Tested: Continuous processing stability, memory leak detection"

  report-results:
    name: ðŸ“Š Report Test Results
    runs-on: ubuntu-latest
    needs: [performance-tests, long-running-tests]
    if: always()
    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "## Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Tests" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Long Running Tests" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.long-running-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip**: Performance tests run daily at 3 AM UTC (12 PM KST)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **Long Running Tests**: Run manually via workflow_dispatch only" >> $GITHUB_STEP_SUMMARY

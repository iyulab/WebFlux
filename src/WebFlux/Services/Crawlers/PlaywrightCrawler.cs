using Microsoft.Extensions.Logging;
using Microsoft.Playwright;
using WebFlux.Core.Interfaces;
using WebFlux.Core.Models;
using WebFlux.Core.Options;

namespace WebFlux.Services.Crawlers;

/// <summary>
/// Playwright Í∏∞Î∞ò ÎèôÏ†Å Î†åÎçîÎßÅ ÌÅ¨Î°§Îü¨
/// JavaScriptÎ°ú Î†åÎçîÎßÅÎêòÎäî SPA (React, Vue, Angular) ÏßÄÏõê
/// </summary>
public class PlaywrightCrawler : BaseCrawler
{
    private readonly ILogger<PlaywrightCrawler> _logger;
    private IPlaywright? _playwright;
    private IBrowser? _browser;
    private readonly SemaphoreSlim _browserLock = new(1, 1);
    private bool _disposed;

    public PlaywrightCrawler(
        IHttpClientService httpClientService,
        IEventPublisher eventPublisher,
        ILogger<PlaywrightCrawler> logger)
        : base(httpClientService, eventPublisher)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Îã®Ïùº URL ÌÅ¨Î°§ÎßÅ (ÎèôÏ†Å Î†åÎçîÎßÅ ÏßÄÏõê)
    /// </summary>
    public override async Task<CrawlResult> CrawlAsync(
        string url,
        CrawlOptions? options = null,
        CancellationToken cancellationToken = default)
    {
        var startTime = DateTimeOffset.UtcNow;

        try
        {
            _logger.LogInformation("üåê Crawling URL with Playwright: {Url}", url);

            _logger.LogInformation("  ‚è≥ Initializing browser...");
            var browser = await GetBrowserAsync(cancellationToken);

            _logger.LogInformation("  ‚è≥ Opening new page...");
            var page = await browser.NewPageAsync();

            try
            {
                // User-Agent ÏÑ§Ï†ï
                if (!string.IsNullOrEmpty(options?.UserAgent))
                {
                    await page.SetExtraHTTPHeadersAsync(new Dictionary<string, string>
                    {
                        ["User-Agent"] = options.UserAgent
                    });
                }

                // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏòµÏÖò
                var timeout = options?.TimeoutMs ?? 30000;
                var gotoOptions = new PageGotoOptions
                {
                    WaitUntil = WaitUntilState.NetworkIdle,
                    Timeout = (float)timeout
                };

                // ÌéòÏù¥ÏßÄ Î°úÎìú
                _logger.LogInformation("  ‚è≥ Loading page (waiting for network idle)...");
                var response = await page.GotoAsync(url, gotoOptions);

                if (response == null)
                {
                    throw new InvalidOperationException($"Failed to load page: {url}");
                }

                _logger.LogInformation("  ‚úÖ Page loaded (Status: {StatusCode})", response.Status);

                // ÌäπÏ†ï ÏÖÄÎ†âÌÑ∞ ÎåÄÍ∏∞ (ÏÑ§Ï†ïÎêú Í≤ΩÏö∞)
                if (!string.IsNullOrEmpty(options?.WaitForSelector))
                {
                    _logger.LogInformation("  ‚è≥ Waiting for selector: {Selector}", options.WaitForSelector);
                    await page.WaitForSelectorAsync(options.WaitForSelector, new()
                    {
                        Timeout = (float)timeout
                    });
                }

                // Ï∂îÍ∞Ä ÎåÄÍ∏∞ ÏãúÍ∞Ñ (JavaScript Ïã§Ìñâ ÏôÑÎ£å)
                if (options?.DelayMs > 0)
                {
                    _logger.LogInformation("  ‚è≥ Waiting {DelayMs}ms for JavaScript execution...", options.DelayMs);
                    await Task.Delay(options.DelayMs, cancellationToken);
                }

                // Ïä§ÌÅ¨Î°§ Ï≤òÎ¶¨ (Lazy Loading ÏΩòÌÖêÏ∏†)
                if (options?.EnableScrolling ?? true)
                {
                    _logger.LogInformation("  ‚è≥ Auto-scrolling page to load lazy content...");
                    await AutoScrollAsync(page, cancellationToken);
                }

                // ÏΩòÌÖêÏ∏† Ï∂îÏ∂ú
                _logger.LogInformation("  ‚è≥ Extracting page content...");
                var content = await page.ContentAsync();
                var title = await page.TitleAsync();

                // Ïù¥ÎØ∏ÏßÄ URL Ï∂îÏ∂ú
                var imageUrls = await page.EvaluateAsync<string[]>(
                    @"() => Array.from(document.images).map(img => img.src)"
                );

                // ÎßÅÌÅ¨ Ï∂îÏ∂ú
                var links = await page.EvaluateAsync<string[]>(
                    @"() => Array.from(document.links).map(a => a.href)"
                );

                var responseTimeMs = (long)(DateTimeOffset.UtcNow - startTime).TotalMilliseconds;

                var result = new CrawlResult
                {
                    Url = url,
                    FinalUrl = page.Url,
                    Content = content,
                    IsSuccess = true,
                    StatusCode = response.Status,
                    ContentType = "text/html",
                    ContentLength = content.Length,
                    ResponseTimeMs = responseTimeMs,
                    CrawledAt = DateTimeOffset.UtcNow,
                    ImageUrls = imageUrls,
                    DiscoveredLinks = links.Where(link => IsValidUrl(link)).ToList(),
                    Metadata = new Dictionary<string, object>
                    {
                        ["Title"] = title,
                        ["RenderedWith"] = "Playwright",
                        ["Browser"] = "Chromium",
                        ["DynamicRendering"] = true
                    }
                };

                UpdateStatistics(result);

                _logger.LogInformation(
                    "Successfully crawled {Url} with Playwright in {ResponseTime}ms",
                    url, responseTimeMs);

                return result;
            }
            finally
            {
                await page.CloseAsync();
            }
        }
        catch (PlaywrightException ex)
        {
            _logger.LogError(ex, "Playwright error while crawling {Url}", url);

            var errorResult = new CrawlResult
            {
                Url = url,
                IsSuccess = false,
                StatusCode = 0,
                ErrorMessage = $"Playwright error: {ex.Message}",
                Exception = ex,
                CrawledAt = DateTimeOffset.UtcNow
            };

            UpdateStatistics(errorResult);
            return errorResult;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error crawling {Url} with Playwright", url);

            var errorResult = new CrawlResult
            {
                Url = url,
                IsSuccess = false,
                StatusCode = 0,
                ErrorMessage = ex.Message,
                Exception = ex,
                CrawledAt = DateTimeOffset.UtcNow
            };

            UpdateStatistics(errorResult);
            return errorResult;
        }
    }

    /// <summary>
    /// ÏûêÎèô Ïä§ÌÅ¨Î°§ (Lazy Loading ÏΩòÌÖêÏ∏† Î°úÎìú)
    /// </summary>
    private async Task AutoScrollAsync(IPage page, CancellationToken cancellationToken)
    {
        try
        {
            await page.EvaluateAsync(@"
                async () => {
                    await new Promise((resolve) => {
                        let totalHeight = 0;
                        const distance = 100;
                        const maxScrolls = 50; // ÏµúÎåÄ Ïä§ÌÅ¨Î°§ ÌöüÏàò
                        let scrolls = 0;

                        const timer = setInterval(() => {
                            const scrollHeight = document.body.scrollHeight;
                            window.scrollBy(0, distance);
                            totalHeight += distance;
                            scrolls++;

                            if (totalHeight >= scrollHeight || scrolls >= maxScrolls) {
                                clearInterval(timer);
                                resolve();
                            }
                        }, 100);
                    });
                }
            ");

            // Ïä§ÌÅ¨Î°§ ÌõÑ Ï∂îÍ∞Ä ÎåÄÍ∏∞
            await Task.Delay(500, cancellationToken);

            _logger.LogDebug("Auto-scroll completed");
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Auto-scroll failed, continuing anyway");
        }
    }

    /// <summary>
    /// Î∏åÎùºÏö∞Ï†Ä Ïù∏Ïä§ÌÑ¥Ïä§ Í∞ÄÏ†∏Ïò§Í∏∞ (Ïû¨ÏÇ¨Ïö©)
    /// </summary>
    private async Task<IBrowser> GetBrowserAsync(CancellationToken cancellationToken)
    {
        if (_browser != null && _browser.IsConnected)
        {
            return _browser;
        }

        await _browserLock.WaitAsync(cancellationToken);
        try
        {
            // Double-check Ìå®ÌÑ¥
            if (_browser != null && _browser.IsConnected)
            {
                return _browser;
            }

            _logger.LogInformation("Initializing Playwright browser");

            // Playwright Ï¥àÍ∏∞Ìôî
            _playwright ??= await Playwright.CreateAsync();

            // Chromium Î∏åÎùºÏö∞Ï†Ä ÏãúÏûë
            _browser = await _playwright.Chromium.LaunchAsync(new BrowserTypeLaunchOptions
            {
                Headless = true,
                Args = new[]
                {
                    "--disable-blink-features=AutomationControlled", // ÏûêÎèôÌôî Í∞êÏßÄ Ïö∞Ìöå
                    "--disable-dev-shm-usage",
                    "--no-sandbox"
                }
            });

            _logger.LogInformation("Playwright browser initialized successfully");

            return _browser;
        }
        finally
        {
            _browserLock.Release();
        }
    }

    /// <summary>
    /// URL Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    /// </summary>
    protected override bool IsValidUrl(string url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return false;

        return Uri.TryCreate(url, UriKind.Absolute, out var uri) &&
               (uri.Scheme == Uri.UriSchemeHttp || uri.Scheme == Uri.UriSchemeHttps);
    }

    /// <summary>
    /// Î¶¨ÏÜåÏä§ Ï†ïÎ¶¨
    /// </summary>
    public override void Dispose()
    {
        if (_disposed)
            return;

        _disposed = true;

        try
        {
            _browser?.DisposeAsync().AsTask().Wait();
            _playwright?.Dispose();
            _browserLock?.Dispose();
        }
        finally
        {
            base.Dispose();
        }
    }
}
